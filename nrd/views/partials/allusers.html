<h1>All Residents</h1>
<p>User controls</p>

{{#if permissions.CREATE_USER}}
<h2>Adding Users</h2>
<p>One kerberos per line. Adding a new user will create an account and send them an email. When inputting Kerberos, do not include @mit.edu.</p>
  <form method="post" action="users">
    <textarea name="kerberosList"></textarea>
    <input type="submit" value="Create">
  </form>
</p>
<h2>Updating Resident Info</h2>
<p>URL to .csv file with kerberoses, resident names, and room numbers (see <a href='http://72.29.29.198/safetythird/data/fall2016-roster.csv'>example</a>)</p>
  <form method="post" action="updateroomnumbers">
    <input type="text" name="url" placeholder="URL of .csv file"></input>
    <input type="submit" value="Update">
  </form>
</p>
{{/if}}

<h2>All Users</h2>
<p>Below is a list of all the users</p>
<p>

<p>
  <table>
    <tr>
      <td>Resident Lookup:</td>
      <td>Sort by:</td>
    </tr>
    <tr>
      <td><input type="text" placeholder="kerberos or full name" class="searchname" /></td>
      <td>
        <input id="firstName" class="slim sort" type="button" value="First Name">
        <input id="lastName" class="slim sort" type="button" value="Last Name">
        <input id="kerberos" class="slim sort" type="button" value="Kerberos">
        <input id="roomNumber" class="slim sort" type="button" value="Room Number">
      </td>
    </tr>
  </table>
</p>

  <table class="displaytable">
    <tr>
      <th>Kerberos</th>
      <th width="240">Resident Name</th>
      <th>Room</th>
      <th>Role</th>
      {{#if permissions.CREATE_USER}}
      <th>Reset Password</th>
      <th>Remove</th>
      {{/if}}
      {{#if permissions.FULL_PERMISSIONS_CONTROL}}
      <th>Login AS</th>
      {{/if}}
    </tr>
    {{#each users}}
    <tr id="{{this.kerberos}}-tr">
      <td>{{this.kerberos}}</td>
      <td>{{this.firstName}} {{this.lastName}}</td>
      <td>{{this.roomNumber}}</td>
      <td>
        {{#if this.changeable}}
        <select id="{{this.kerberos}}-changeperms">
          {{#each this.changeOptions}}
          <option value="{{this.value}}" {{this.selected}}>
          {{this.name}}
          </option>
          {{/each}}
        </select>
        <span class="permissionStatus"></span>
        {{else}}
        {{this.groupName}}
        {{/if}}
      </td>
      {{#if ../permissions.CREATE_USER}}
      <td><a id="{{this.kerberos}}-pwreset" class="pwreset">reset pass</a></td>
      <td><a id="{{this.kerberos}}-remove" class="remove">X</a></td>
      {{/if}}
      {{#if ../permissions.FULL_PERMISSIONS_CONTROL}}
      <td><a id="{{this.kerberos}}-loginas" class="loginas">login</a></td>
      {{/if}}
    </tr>
    {{/each}}
  </table>
  </p>

<script type="text/javascript">
  {{#if permissions.FULL_PERMISSIONS_CONTROL}}
  // login as another user
  $('.loginas').on('click', function(e) {
    var id = e.target.id;
    kerberos = id.substring(0, id.length-'-loginas'.length);
    $.post('/loginas', {kerberos: kerberos}, function(data) {
      if (!data.err) {
        window.location.replace('/');
      }
    });
  });
  {{/if}}

  {{#if permissions.CREATE_USER}}
  $('.remove').on('click', function(e) {
    var yes = $('<a>').html('yes').on('click',
      function(e2) {
        kerberos = e.target.id;
        kerberos = kerberos.substring(0,kerberos.length-'-remove'.length);
        $.ajax('/removeuser',{data:{kerberos:kerberos}, type:"POST"});
        $('#'+kerberos+'-tr').remove();
      }
    );
    var no = $('<a>').html('no').on('click',
      function(e2) { $(e.target).html('X'); }
    );
    $(e.target).html(yes).append('&nbsp;&nbsp;').append(no);
  });

  $('.pwreset').on('click', function(e) {
    var yes = $('<a>').html('yes').on('click',
      function(e2) {
        kerberos = e.target.id;
        kerberos = kerberos.substring(0,kerberos.length-'-pwreset'.length);
        $.ajax('/resetpassword',{data:{kerberos:kerberos}, type:"POST"});
        $(e.target).html('password reset');
      }
    );
    var no = $('<a>').html('no').on('click',
      function(e2) { $(e.target).html('reset pass'); }
    );
    $(e.target).html(yes).append('&nbsp;&nbsp;').append(no);
  });
  {{/if}}
  
  {{#if permissions.MAKE_USERS_DESKWORKERS}}
  $('select').change(function(e) {
  	var chosen = $(this).val();
    var selectId = e.target.id;
    kerberos = selectId.split('-')[0];
  	$.post('/changepermission', {kerberos:kerberos, permission:chosen}, function(data) {
        if (!data.error) {
  	  	  $flashmsg = $('#' + selectId).parent().find('.permissionStatus');
  	  	  $flashmsg.show().text('done').delay(1000).fadeOut(500);
  	    } else {
  	      $('#' + selectId).parent().find('.permissionStatus').text('error - contact nextres-dev@mit.edu');
  	    }
  	});
  });

  var updateList = function(query){
    $.get("searchusers", query)
      .done(function(data) {
        if (data) {
          var users = data.users;
          var permissions = data.permissions;
          var html = '<tr><th>Kerberos</th><th>Resident Name</th><th>Room</th><th>Role</th>';
          if (permissions.CREATE_USER) {
            html += '<th>Reset Password</th><th>Remove</th>';
          }
          if (permissions.FULL_PERMISSIONS_CONTROL) {
            html += "<th>Login AS</th>" ;
          }
          html += "</tr>";
          for (var i in users) {
            var user = users[i];
            html += '<tr id="' + user.kerberos + '-tr">'
            html += "<td>" + user.kerberos + "</td>"
            html += "<td>" + user.firstName + " " + user.lastName + "</td>"
            html += "<td>" + user.roomNumber + "</td>"
            var select = '<select id="' + user.kerberos + '-changeperms">'
            for (var j in user.changeOptions) {
              var option = user.changeOptions[j];
              select += '<option value="' + option.value + '" ' + option.selected + '>' + option.name + "</option>"

            }
            select += '</select><span class="permissionStatus"></span>'
            html += "<td>" + (user.changeable ? select : user.groupName) + "</td>"
            if (permissions.CREATE_USER) {
              html += '<td><a id="' + user.kerberos + '-pwreset" class="pwreset">reset pass</a></td>'
              html += '<td><a id="' + user.kerberos + '-remove" class="remove">X</a></td>'
            }
            if (permissions.FULL_PERMISSIONS_CONTROL) {
              html += '<td><a id="' + user.kerberos + '-loginas" class="loginas">login</a></td>'
            }
            html += "</tr>"
          }
          $(".displaytable").html(html);
        } else {
          $(".displaytable").hide();
          $('.error-msg').show();
        }
    }).fail(function() {
        $('.error-msg').show();
        $('.error-msg').html('A serious error has occured. Please contact nextres-dev@mit.edu, or refresh the page');
    });
  }
  {{/if}}

  $('.sort').on('click', function() {
    $('.sort').attr('class', 'slim sort');
    $(this).attr('class', 'slim sort active');
    sortBy = $(this).attr('id');
    searchname = $('.searchname').val();
    updateList({kerberosSearchPattern: searchname, sortBy: sortBy });
  });

  $('.searchname').on('input', function(){
    searchname = $(this).val();
    updateList({kerberosSearchPattern: searchname, sortBy: sortBy });
  });

</script>
